<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../Assets/Logo fundo branco.png" type="image/x-icon">
    <title>Vagas Abertas - Optimiza</title>
    <link rel="stylesheet" href="../css/vagasAbertas.css">
    <link rel="stylesheet" href="../css/menu.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <!-- Menu -->
    <div class="header">
        <div class="container">
            <div class="header-left">
                <img src="../Assets/Logo fundo branco.png" alt="Optimiza" class="register-logo">
                <div class="optimiza-inicial">
                    Optimiza
                </div>
            </div>
            <div class="header-center">
                <div class="menu-text">
                    <a href="home.html">Home</a>
                </div>
                <div class="menu-container">
                    <button class="menu-btn menu-text pag">Vagas</button>
                    <div class="dropdown-content">
                        <a href="aberturaVaga.html">Abrir Vaga</a>
                        <a href="vagasAbertas.html">Vagas Abertas</a>
                    </div>
                </div>
                <div class="menu-text">
                    <a href="bancoDeTalentos.html">Banco de Talentos</a>
                </div>
                <div class="menu-text">
                    <a href="painel.html">Anal√≠tico</a>
                </div>
                <div class="menu-text">
                    <a href="http://34.195.148.77/chamado/">Ajuda</a>
                </div>
            </div>
            <div class="header-right">
                <img src="../Assets/profile.png" class="icon-profile" alt="">
                <div class="menu-profile" id="profile-name">
                    Perfil
                </div>
            </div>
        </div>
    </div>

    <!-- Conte√∫do principal Listagem de vagas abertas -->
    <div class="talentos-container">
        <h2 class="talentos-title">Vagas Abertas</h2>
        <div class="talentos-actions">
            <input type="text" placeholder="Buscar por t√≠tulo" class="talentos-search" id="filtro-titulo">
            <div class="filtro-dropdown-container" style="display:inline-block; position:relative;">
                <button class="talentos-btn talentos-btn-filter" id="btn-dropdown">Filtros ‚ñº</button>
                <div class="filtro-dropdown" id="dropdown-filtros"
                    style="display:none; position:absolute; left:0; top:110%; background:#fff; border:1px solid #ccc; border-radius:0.5rem; padding:1rem; z-index:10; min-width:220px; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
                    <select id="select-filtro" class="filtro-select" style="width:100%; margin-bottom:0.7rem;">
                        <option value="cargo">Cargo</option>
                        <option value="nivelFormacao">N√≠vel de Forma√ß√£o</option>
                        <option value="idiomas">Idiomas</option>
                    </select>
                    <input type="text" id="input-filtro" class="filtro-input" placeholder="Digite o valor"
                        style="width:100%; margin-bottom:0.7rem;">
                    <button id="btn-aplicar-filtro" class="talentos-btn talentos-btn-search"
                        style="width:100%;">Aplicar</button>
                </div>
                <span id="indicadores-filtros" style="margin-left:1rem;"></span>
            </div>
        </div>
        <div class="description-table-jobs">
            <table class="table-description">
                <thead>
                    <tr>
                        <th class="description-names"><strong>T√≠tulo da Vaga</strong></th>
                        <th class="description-names"><strong>Cargo</strong></th>
                        <th class="description-names"><strong>N√≠vel de Forma√ß√£o</strong></th>
                        <th class="description-names"><strong>Idiomas</strong></th>
                    </tr>
                </thead>
            </table>
        </div>

        <div class="talentos-list-scroll">
            <table class="talentos-table">
                <tbody id="talentos-list">
                </tbody>
            </table>
        </div>

        <!-- Modal para detalhes do candidato -->
        <div id="modal-candidato" class="modal-candidato" style="display:none;">
            <div class="modal-content">
                <span class="modal-close" id="modal-close">&times;</span>
                <h3 id="modal-nome"></h3>
                <p><strong>N√≠vel de Forma√ß√£o:</strong> <span id="modal-nivel"></span></p>
                <p><strong>Curso:</strong> <span id="modal-curso"></span></p>
                <p><strong>Status:</strong> <span id="modal-status"></span></p>
            </div>
        </div>

        <!-- Modal de Detalhes da Vaga -->
        <div id="modal-vaga" class="modal-overlay">
            <div class="modal-content">
                <span class="close-btn" id="close-modal">&times;</span>
                <h2 class="modal-title">Vaga <span id="modal-titulo"></span></h2>

                <div class="vaga-status">
                    <div class="vaga-etapa">
                        <div class="bolinha"></div>
                        <p>Aguardando Aprova√ß√£o RH</p>
                    </div>
                    <div class="linha"></div>
                    <div class="vaga-etapa ativa">
                        <div class="bolinha"></div>
                        <p>Entrevistando Candidatos</p>
                    </div>
                    <div class="linha"></div>
                    <div class="vaga-etapa">
                        <div class="bolinha"></div>
                        <p>Admiss√£o Conclu√≠da</p>
                    </div>
                </div>

                <!-- Main info: duas colunas estilo "detalhes" (n√£o inputs) -->
                <section class="modal-details">
                    <div class="details-left">
                        <div class="detail-row">
                            <div class="detail-label">T√≠tulo</div>
                            <div class="detail-value" id="titulo-vaga-display"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Cargo</div>
                            <div class="detail-value" id="cargo-vaga-display"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Experi√™ncia</div>
                            <div class="detail-value" id="experiencia-vaga-display"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">√Årea de Forma√ß√£o</div>
                            <div class="detail-value" id="area-vaga-display"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">N√≠vel de Forma√ß√£o</div>
                            <div class="detail-value" id="nivel-vaga-display"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Idiomas</div>
                            <div class="detail-value" id="idiomas-vaga-display"></div>
                        </div>
                        <!-- Novo campo para Status -->
                        <div class="detail-row">
                            <div class="detail-label">Status</div>
                            <div class="detail-value" id="modal-status-display"></div>
                        </div>
                    </div>

                    <div class="details-right">
                        <div class="detail-block">
                            <div class="detail-label right">Palavras-Chave</div>
                            <div class="keywords-box" id="palavras-vaga-display"></div>
                        </div>
                    </div>
                </section>


                <!-- Buttons: alinhamento central com espa√ßamento -->
                <footer class="modal-actions">
                    <button class="btn action ver-candidatos">Ver Candidatos</button>
                    <button class="btn action editar">Editar Vaga</button>
                    <!-- bot√£o de a√ß√£o que muda conforme status: Aprovar Vaga ou Concluir Vaga -->
                    <button id="btn-acao-vaga" class="btn action aprovar">Aprovar Vaga</button>
                    <button class="btn action apagar vermelho">Apagar Vaga</button>
                </footer>
            </div>
        </div>

    </div>
    </div>
    <script>
        // Exibe o nome do usu√°rio salvo no localStorage ao lado da foto de perfil
        window.addEventListener('DOMContentLoaded', function () {
            var nomeUsuario = localStorage.getItem('nomeUsuario');
            if (nomeUsuario) {
                document.getElementById('profile-name').textContent = nomeUsuario;
            }
        });
    </script>
</body>

<script>
    let filtrosExtras = {};
    let todasVagas = [];
    let currentVagaId = null;
    function formatarTexto(texto) {
        if (!texto) return '';
        // Substitui h√≠fens e underlines por espa√ßo, coloca cada palavra com inicial mai√∫scula
        return texto.replace(/[-_]/g, ' ')
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    function formatarIdiomas(idiomas) {
        if (!idiomas) return '';
        // Se vier como array simples
        if (Array.isArray(idiomas)) {
            return idiomas.map(i => formatarTexto(i)).join(', ');
        }
        // Se vier como objeto { "Ingl√™s": "B2", ... }
        if (typeof idiomas === 'object') {
            return Object.entries(idiomas)
                .map(([lang, nivel]) => `${formatarTexto(lang)}${nivel ? ' (' + nivel.toUpperCase() + ')' : ''}`)
                .join(', ');
        }
        return '';
    }

    // Helper para evitar erros quando um id n√£o existe no DOM
    function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value == null ? '' : String(value);
    }

    // Mapeia idArea conhecidos para nomes (fallback; pode ser ajustado conforme backend)
    const MAP_AREAS = { 1: 'Financeiro', 2: 'Recursos Humanos', 3: 'TI', 4: 'Marketing', 5: 'Opera√ß√µes' };
    function obterNomeArea(infoArea) {
        if (typeof infoArea === 'string') return formatarTexto(infoArea);
        if (typeof infoArea === 'number') return MAP_AREAS[infoArea] || String(infoArea);
        return '';
    }

    // Converte etapa do backend para label amig√°vel usado na barra
    function etapaParaLabel(etapa, status) {
        const raw = ((etapa || status || '') + '').toLowerCase().replace(/[_-]/g, ' ');
        // Default para novas vagas: Aguardando Aprova√ß√£o RH
        if (!raw) return 'Aguardando Aprova√ß√£o RH';
        if (
            raw.includes('aprovacao rh') ||
            raw.includes('aprova√ß√£o rh') ||
            raw.includes('aguardando') ||
            raw.includes('vaga aberta') ||
            raw.includes('aberta')
        ) return 'Aguardando Aprova√ß√£o RH';
        if (raw.includes('entrevista') || raw.includes('entrevistando')) return 'Entrevistando Candidatos';
        if (raw.includes('admiss')) return 'Admiss√£o Conclu√≠da';
        // fallback amig√°vel
        return 'Aguardando Aprova√ß√£o RH';
    }
    function renderizarVagas(vagas) {
        const tbody = document.getElementById('talentos-list');
        tbody.innerHTML = '';
        if (vagas.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align:center; color:#888; padding:2rem;">Nenhuma vaga encontrada.</td>`;
            tbody.appendChild(tr);
            return;
        }
        vagas.forEach((vaga, idx) => {
            const rowClass = idx % 2 === 0 ? 'talentos-row talentos-row-alt' : 'talentos-row talentos-row-normal';
            const tr = document.createElement('tr');
            tr.className = rowClass;
            const tituloFormatado = formatarTexto(vaga.titulo);
            const cargoFormatado = formatarTexto(vaga.cargo);
            const nivelFormatado = formatarTexto(vaga.nivelFormacao);
            const idiomasFormatados = formatarIdiomas(vaga.idiomas);
            const etapaLabel = etapaParaLabel(vaga.etapaVaga, vaga.status);
            // Diminui a opacidade para vagas ainda n√£o aprovadas
            if (etapaLabel === 'Vaga Aberta' || etapaLabel === 'Aguardando Aprova√ß√£o RH') {
                tr.classList.add('vaga-pendente-aprovacao');
                tr.title = 'Aguardando aprova√ß√£o do RH';
            }
            // Guarda o id (normalizado) no dataset para facilitar debugs
            const idNorm = vaga?.id ?? vaga?.idVaga ?? vaga?.vagaId ?? null;
            if (idNorm != null) tr.dataset.idVaga = idNorm;
            tr.innerHTML = `
                <td class="talentos-nome"><strong>${tituloFormatado}</strong></td>
                <td class="talentos-nome"><strong>${cargoFormatado}</strong></td>
                <td class="talentos-nome"><strong>${nivelFormatado}</strong></td>
                <td class="talentos-nome"><strong>${idiomasFormatados}</strong></td>
            `;

            // üëâ Aqui adiciona o clique para abrir o modal
            tr.addEventListener('click', () => abrirModal(vaga));

            tbody.appendChild(tr);
        });
    }
    async function carregarVagas() {
        try {
            var idArea = localStorage.getItem('idAreaUsuario');
            let url = `http://localhost:8080/optimiza/vagas?idArea=${idArea}`;
            let params = [];
            Object.keys(filtrosExtras).forEach(key => {
                if (filtrosExtras[key]) params.push(`${key}=${encodeURIComponent(filtrosExtras[key])}`);
            });
            if (params.length > 0) {
                url += '&' + params.join('&');
            }
            const response = await fetch(url);
            const lista = await response.json();
            // Normaliza ID para garantir que cada item tenha a propriedade "id"
            todasVagas = (Array.isArray(lista) ? lista : []).map(v => ({
                ...v,
                id: v?.id ?? v?.idVaga ?? v?.vagaId ?? v?.codigo ?? v?.ID ?? v?.Id ?? null
            }));
            filtrarEVizualizarVagas();
        } catch (error) {
            console.error('Erro ao carregar vagas:', error);
        }
    }
    document.addEventListener('DOMContentLoaded', function () {
        // Busca por t√≠tulo em tempo real
        document.getElementById('filtro-titulo').addEventListener('input', function () {
            filtrarEVizualizarVagas();
        });
        // Dropdown de filtros extras
        const btnDropdown = document.getElementById('btn-dropdown');
        const dropdown = document.getElementById('dropdown-filtros');
        btnDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });
        document.getElementById('btn-aplicar-filtro').addEventListener('click', function () {
            const campo = document.getElementById('select-filtro').value;
            const valor = document.getElementById('input-filtro').value.trim();
            if (valor) {
                filtrosExtras[campo] = valor;
                atualizarIndicadoresFiltros();
                carregarVagas(); // Recarrega as vagas com filtros na URL
            }
            dropdown.style.display = 'none';
            document.getElementById('input-filtro').value = '';
        });
        function atualizarIndicadoresFiltros() {
            const container = document.getElementById('indicadores-filtros');
            container.innerHTML = '';
            Object.keys(filtrosExtras).forEach(key => {
                const span = document.createElement('span');
                span.className = 'filtro-indicador';
                span.style.background = '#e9e9f7';
                span.style.color = '#032656';
                span.style.padding = '0.3rem 0.7rem';
                span.style.borderRadius = '1rem';
                span.style.fontSize = '0.95em';
                span.style.marginRight = '0.5rem';
                span.style.display = 'inline-flex';
                span.style.alignItems = 'center';
                span.innerHTML = `${key}: ${filtrosExtras[key]} <button class='filtro-remove' data-remove='${key}' style='margin-left:0.5rem; background:none; border:none; color:#6C63FF; font-weight:bold; cursor:pointer; font-size:1em;'>x</button>`;
                container.appendChild(span);
            });
            container.querySelectorAll('button[data-remove]').forEach(btn => {
                btn.onclick = function () {
                    const campo = btn.getAttribute('data-remove');
                    delete filtrosExtras[campo];
                    atualizarIndicadoresFiltros();
                    carregarVagas(); // Recarrega as vagas com filtros na URL
                };
            });
        }
        // Fecha dropdown ao clicar fora
        document.addEventListener('click', function (e) {
            if (!dropdown.contains(e.target) && e.target !== btnDropdown) {
                dropdown.style.display = 'none';
            }
        });
    });
    function filtrarEVizualizarVagas() {
        const termo = document.getElementById('filtro-titulo').value.trim().toLowerCase();
        let vagasFiltradas = todasVagas;
        if (termo) {
            vagasFiltradas = vagasFiltradas.filter(vaga => formatarTexto(vaga.titulo).toLowerCase().includes(termo));
        }
        Object.keys(filtrosExtras).forEach(key => {
            const valor = filtrosExtras[key].toLowerCase();
            vagasFiltradas = vagasFiltradas.filter(vaga => {
                if (key === 'idiomas') {
                    if (!vaga.idiomas) return false;
                    if (Array.isArray(vaga.idiomas)) {
                        return vaga.idiomas.some(idioma => formatarTexto(idioma).toLowerCase().includes(valor));
                    }
                    // objeto map
                    return Object.keys(vaga.idiomas).some(id => formatarTexto(id).toLowerCase().includes(valor) || (vaga.idiomas[id] && vaga.idiomas[id].toLowerCase().includes(valor)));
                }
                return vaga[key] && formatarTexto(vaga[key]).toLowerCase().includes(valor);
            });
        });
        renderizarVagas(vagasFiltradas);
    }
    window.onload = function () {
        carregarVagas();
        document.getElementById('talentos-list').addEventListener('click', function (e) {
            if (e.target.classList.contains('talentos-link')) {
                e.preventDefault();
                document.getElementById('modal-nome').textContent = e.target.getAttribute('data-titulo');
                document.getElementById('modal-nivel').textContent = '';
                document.getElementById('modal-curso').textContent = e.target.getAttribute('data-cargo');
                document.getElementById('modal-status').textContent = '';
                document.getElementById('modal-candidato').style.display = 'flex';
            }
        });
        document.getElementById('modal-close').onclick = function () {
            document.getElementById('modal-candidato').style.display = 'none';
        };
        window.onclick = function (event) {
            if (event.target === document.getElementById('modal-candidato')) {
                document.getElementById('modal-candidato').style.display = 'none';
            }
        };
    };

    // Abre o modal com as informa√ß√µes da vaga
    async function abrirModal(vaga) {
        try {
            // tenta v√°rias chaves comuns para ID
            const id = (vaga && (
                vaga.id ?? vaga.idVaga ?? vaga.vagaId ?? vaga.codigo ?? vaga.ID ?? vaga.Id
            )) ?? null;
            currentVagaId = id;
            let dados = vaga;
            if (id != null) {
                const resp = await fetch(`http://localhost:8080/optimiza/vagas/${id}`);
                if (resp.ok) {
                    dados = await resp.json();
                    // se a API devolver o id, confirma no estado atual
                    if (dados && (dados.id != null)) currentVagaId = dados.id;
                }
            }

            // Fallback caso n√£o haja resposta detalhada
            dados = dados || {};

            const labelEtapa = etapaParaLabel(dados.etapaVaga, dados.status);

            setText('modal-titulo', dados.titulo || vaga?.titulo || '');
            setText('modal-status-display', labelEtapa);
            setText('titulo-vaga-display', dados.titulo || '');
            setText('cargo-vaga-display', formatarTexto(dados.cargo));
            setText('experiencia-vaga-display', dados.experiencia || '');
            setText('area-vaga-display', obterNomeArea(dados.area || dados.idArea));
            setText('nivel-vaga-display', formatarTexto(dados.nivelFormacao));
            setText('idiomas-vaga-display', formatarIdiomas(dados.idiomas));

            const palavras = Array.isArray(dados.palavrasChave)
                ? dados.palavrasChave.join('\n')
                : (dados.palavrasChave || '');
            setText('palavras-vaga-display', palavras);

            atualizarProgresso((labelEtapa || '').toLowerCase());
            document.getElementById('modal-vaga').style.display = 'flex';
        } catch (e) {
            console.error('Erro ao abrir modal da vaga:', e);
            Swal.fire({
                icon: 'error',
                title: 'Erro ao carregar',
                text: 'N√£o foi poss√≠vel carregar os detalhes da vaga.',
                confirmButtonText: 'Ok'
            });
        }
    }

    // Fecha o modal ao clicar no bot√£o X
    document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('modal-vaga').style.display = 'none';
    });

    // Fecha ao clicar fora do conte√∫do
    window.addEventListener('click', e => {
        const modal = document.getElementById('modal-vaga');
        if (e.target === modal) modal.style.display = 'none';
    });

    // Atualiza as bolinhas de status (3 etapas na UI)
    function atualizarProgresso(status) {
        const etapas = document.querySelectorAll('.vaga-etapa');
        etapas.forEach(etapa => etapa.classList.remove('ativa'));
        const s = (status || '').toLowerCase();
        if (s.includes('aprov') || s.includes('aguard') || s.includes('vaga aberta') || s.includes('aberta')) {
            etapas[0]?.classList.add('ativa');
        } else if (s.includes('entrevista')) {
            etapas[1]?.classList.add('ativa');
        } else if (s.includes('admiss')) {
            etapas[2]?.classList.add('ativa');
        } else {
            etapas[0]?.classList.add('ativa'); // fallback
        }
    }



    // Preenche os campos display (chame isso dentro de abrirModal antes de mostrar o modal)
    function preencherModalDisplay(vaga) {
        document.getElementById('modal-titulo').textContent = vaga.titulo || '';
        document.getElementById('modal-status-display').textContent = vaga.status || '';
        document.getElementById('titulo-vaga-display').textContent = vaga.titulo || '';
        document.getElementById('cargo-vaga-display').textContent = vaga.cargo || '';
        document.getElementById('experiencia-vaga-display').textContent = vaga.experiencia || '';
        document.getElementById('area-vaga-display').textContent = vaga.area || '';
        document.getElementById('nivel-vaga-display').textContent = vaga.nivelFormacao || '';
        document.getElementById('idiomas-vaga-display').textContent = Array.isArray(vaga.idiomas)
            ? vaga.idiomas.join(', ')
            : (vaga.idiomas ? Object.entries(vaga.idiomas).map(([k, v]) => `${k} (${v})`).join(', ') : '');

        // palavras-chave (manter quebras de linha)
        const palavras = vaga.palavrasChave ? (Array.isArray(vaga.palavrasChave) ? vaga.palavrasChave.join('\n') : String(vaga.palavrasChave)) : '';
        document.getElementById('palavras-vaga-display').textContent = palavras;
    }

    // Handler do bot√£o Aprovar (chama backend e atualiza UI)
    document.querySelector('.modal-actions .aprovar')?.addEventListener('click', async function () {
        if (!currentVagaId) {
            Swal.fire({
                icon: 'info',
                title: 'Sem ID da vaga',
                text: 'ID da vaga n√£o identificado.',
                confirmButtonText: 'Ok'
            });
            return;
        }
        const confirmar = await Swal.fire({
            icon: 'question',
            title: 'Aprovar vaga?',
            text: 'Esta a√ß√£o mover√° a vaga para Entrevistando Candidatos.',
            showCancelButton: true,
            confirmButtonText: 'Aprovar',
            cancelButtonText: 'Cancelar'
        });
        if (!confirmar.isConfirmed) return;
        try {
            const resp = await fetch(`http://localhost:8080/optimiza/vagas/aprovacao-rh/${currentVagaId}?aprovado=true`, {
                method: 'PUT'
            });
            if (!resp.ok) throw new Error('Falha ao aprovar a vaga');
            // Sucesso visual
            await Swal.fire({
                icon: 'success',
                title: 'Vaga aprovada',
                text: 'A vaga foi aprovada com sucesso.',
                timer: 1600,
                showConfirmButton: false
            });
            // Ap√≥s aprova√ß√£o, avan√ßamos para "Entrevistando Candidatos"
            setText('modal-status-display', 'Entrevistando Candidatos');
            atualizarProgresso('entrevistando candidatos');
            // Recarrega lista para refletir poss√≠veis mudan√ßas
            try { carregarVagas(); } catch { }
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Erro ao aprovar',
                text: 'N√£o foi poss√≠vel aprovar a vaga. Verifique o console.',
                confirmButtonText: 'Ok'
            });
        }
    });

    // Navega para tela de match levando o id da vaga
    document.querySelector('.modal-actions .ver-candidatos')?.addEventListener('click', function () {
        if (!currentVagaId) {
            alert('ID da vaga n√£o identificado.');
            return;
        }
        const titulo = document.getElementById('modal-titulo')?.textContent || '';
        try {
            localStorage.setItem('idVaga', String(currentVagaId));
            localStorage.setItem('idVagaSelecionada', String(currentVagaId));
            if (titulo) localStorage.setItem('nomeVaga', titulo);
        } catch {}
        window.location.href = `match.html?idVaga=${encodeURIComponent(currentVagaId)}`;
    });


</script>

<script src="../js/sessoes.js"></script>

</html>