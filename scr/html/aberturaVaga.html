<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../Assets/Logo fundo branco.png" type="image/x-icon">
    <title>Abertura de Vaga - Optimiza</title>
    <link rel="stylesheet" href="../css/aberturaVaga.css">
    <link rel="stylesheet" href="../css/menu.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <!-- Menu -->
    <div class="header">
        <div class="container">
            <div class="header-left">
                <img src="../Assets/Logo fundo branco.png" alt="Optimiza" class="register-logo">
                <div class="optimiza-inicial">
                    Optimiza
                </div>
            </div>
            <div class="header-center">
                <div class="menu-text">
                    <a href="home.html">Home</a>
                </div>
                <div class="menu-container">
                    <button class="menu-btn menu-text pag">Vagas</button>
                    <div class="dropdown-content">
                        <a href="aberturaVaga.html">Abrir Vaga</a>
                        <a href="vagasAbertas.html">Vagas Abertas</a>
                    </div>
                </div>
                <div class="menu-text">
                    <a href="bancoDeTalentos.html">Banco de Talentos</a>
                </div>
                <div class="menu-text">
                    <a href="painel.html">Analítico</a>
                </div>
                <div class="menu-text">
                    <a href="http://54.145.158.250:8000/chamado/">Ajuda</a>
                </div>
            </div>
            <div class="header-right">
                <img src="../Assets/profile.png" class="icon-profile" alt="">
                <div class="menu-profile" id="profile-name">
                    Perfil
                </div>
            </div>
        </div>
    </div>
    <!-- Fim do menu -->

    <!-- Botão de sugestão de vaga centralizado abaixo do menu -->
    <div style="width:90%; display:flex; justify-content:flex-start; margin-top:1.5rem; margin-left:5.5rem;">
        <button id="btn-sugestao-vaga" class="btn-submit" style="width:13rem;">Sugestão de Vaga</button>
    </div>

    <!-- Inicio forms -->
    <div class="form-container">
        <h2 class="form-title">Abertura de Vaga</h2>
        <form>
            <div class="form">
                <div class="form-left">
                    <div class="form-group">
                        <label for="jobTitle">Título da Vaga</label>
                        <input type="text" id="jobTitle">
                    </div>
                    <div class="form-group">
                        <label for="position">Cargo</label>
                        <select id="position">
                            <option value=""></option>
                            <option value="jovem-aprendiz">Jovem Aprendiz</option>
                            <option value="estagiario">Estagiário</option>
                            <option value="analista-jr">Analista Júnior</option>
                            <option value="analista-pl">Analista Pleno</option>
                            <option value="analista-sr">Analista Sênior</option>
                            <option value="specialist">Especialista I</option>
                            <option value="tech-lead">Tech Lead</option>
                            <option value="manager">Gerente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="experience">Experiência</label>
                        <select id="experience">
                            <option value=""></option>
                            <option value="none">Nenhuma</option>
                            <option value="1-3">1-3 anos</option>
                            <option value="3-5">3-5 anos</option>
                            <option value="5plus">5+ anos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="levelDegree">Nível de Graduação</label>
                        <select id="levelDegree">
                            <option value=""></option>
                            <option value="Ensino_Fundamental_completo">Ensino Fundamental completo</option>
                            <option value="Ensino_Medio_incompleto">Ensino Médio incompleto</option>
                            <option value="Ensino_Medio_completo">Ensino Médio completo</option>
                            <option value="Ensino_Superior_cursando">Ensino Superior cursando</option>
                            <option value="Ensino_Superior_completo">Ensino Superior completo</option>
                            <option value="Pos_graduacao">Pós-graduação</option>
                            <option value="Mestrado">Mestrado</option>
                            <option value="Doutorado">Doutorado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="education">Instituição de Ensino</label>
                        <input type="text" id="education">
                    </div>
                    <div class="form-group">
                        <label for="degree">Formação</label>
                        <input type="text" id="degree">
                    </div>                   
                </div>
                <div class="form-right">              
                    <div class="languages-block">
                        <div class="form-group">
                            <label for="languages">Idiomas</label>
                            <input type="text" id="languages">
                        </div>
                        <div class="form-group">
                            <label for="languagesLevel">Nível do Idioma</label>
                            <select id="languagesLevel">
                                <option value=""></option>
                                <option value="A1">A1 - BÁSICO INICIANTE</option>
                                <option value="A2">A2 - BÁSICO INTERMEDIÁRIO</option>
                                <option value="B1">B1 - FALANTE INDEPENDENTE BÁSICO</option>
                                <option value="B2">B2 - FALANTE INDEPENDENTE AVANÇADO</option>
                                <option value="C1">C1 - PROFICIENTE AVANÇADO</option>
                                <option value="C2">C2 - DOMÍNIO PLENO</option>
                            </select>
                        </div>
                        <div class="languages-button">
                            <button class="btn-languages" type="button">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="keywords">Palavras-Chave <small>(Separe por vírgula, ponto e vírgula ou quebra de linha)</small></label>
                        <textarea id="keywords"></textarea>
                    </div>
                    <div class="form-button">
                        <button class="btn-submit" type="submit">Abrir Vaga</button>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <!-- Fim forms -->

    <!-- Modal de sugestão de vaga -->
    <div id="modal-sugestao-vaga" class="modal-sugestao-vaga" style="display:none;">
        <div class="modal-sugestao-content">
            <span id="close-modal-sugestao" class="close-modal-sugestao">&times;</span>
            <h3 class="modal-sugestao-title">Sugestão de Vagas</h3>
            <ul id="lista-sugestao-vagas" class="modal-sugestao-list"></ul>
        </div>
    </div>

 <script>    
    // Exibe o nome do usuário salvo no localStorage ao lado da foto de perfil
    window.addEventListener('DOMContentLoaded', function() {
        var nomeUsuario = localStorage.getItem('nomeUsuario');
        if (nomeUsuario) {
            document.getElementById('profile-name').textContent = nomeUsuario;
        }
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const addButton = document.querySelector('.btn-languages');
    const languagesContainer = document.querySelector('.languages-block').parentNode; 

    addButton.addEventListener('click', () => {
        // cria um novo bloco de idiomas
        const newBlock = document.createElement('div');
        newBlock.classList.add('languages-block');

        newBlock.innerHTML = `
            <div class="form-group">
                <label>Idiomas</label>
                <input type="text" name="languages[]">
            </div>
            <div class="form-group">
                <label>Nível do Idioma</label>
                <select name="languagesLevel[]">
                    <option value=""></option>
                    <option value="A1">A1 - BÁSICO INICIANTE</option>
                    <option value="A2">A2 - BÁSICO INTERMEDIÁRIO</option>
                    <option value="B1">B1 - FALANTE INDEPENDENTE BÁSICO</option>
                    <option value="B2">B2 - FALANTE INDEPENDENTE AVANÇADO</option>
                    <option value="C1">C1 - PROFICIENTE AVANÇADO</option>
                    <option value="C2">C2 - DOMÍNIO PLENO</option>
                </select>
            </div>
            <div class="languages-button">
                <button class="btn-remove" type="button">×</button>
            </div>
        `;

        // Os inputs têm name="languages[]" e name="languagesLevel[]" para facilitar o envio como arrays no back-end.

        // adiciona o novo bloco antes do botão principal
        languagesContainer.insertBefore(newBlock, addButton.closest('.languages-block').nextSibling);

        // adiciona evento para remover o bloco se clicar no "x"
        const removeBtn = newBlock.querySelector('.btn-remove');
        removeBtn.addEventListener('click', () => {
            newBlock.remove();
        });
    });
});
</script>

</body>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  if (!form) return;

  // helper: encontra ou cria <small class="error"> dentro do mesmo form-group
  function getErrorEl(field) {
    if (!field) return null;
    const parent = field.parentElement || field;
    let existing = parent.querySelector('small.error');
    if (existing) return existing;

    if (field.id) {
      const byId = document.getElementById('error-' + field.id);
      if (byId) return byId;
    }

    const small = document.createElement('small');
    small.className = 'error';
    small.id = 'error-' + (field.id || Math.random().toString(36).slice(2,7));
    parent.appendChild(small);
    return small;
  }

  function setError(field, message) {
    if (!field) return;
    const err = getErrorEl(field);
    if (!err) return;
    err.textContent = message;
    err.style.color = '#d32f2f';
    err.style.display = 'block';
    field.classList.add('input-error');
  }

  function clearError(field) {
    if (!field) return;
    const parent = field.parentElement || field;
    const existing = parent.querySelector('small.error');
    if (existing) existing.textContent = '';
    field.classList.remove('input-error');
  }

  // limpa tudo
  function clearAllErrors() {
    form.querySelectorAll('small.error').forEach(s => s.textContent = '');
    form.querySelectorAll('.input-error').forEach(i => i.classList.remove('input-error'));
  }

  // adiciona listeners para limpar erro quando o usuário digitar/mudar
  ['jobTitle','position','experience','levelDegree','education','degree','languages','languagesLevel','keywords'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const event = el.tagName.toLowerCase() === 'select' ? 'change' : 'input';
    el.addEventListener(event, () => clearError(el));
  });

  // valida os campos
  function validate() {
    clearAllErrors();

    const jobTitle = document.getElementById('jobTitle');
    const position = document.getElementById('position');
    const experience = document.getElementById('experience');
    const levelDegree = document.getElementById('levelDegree');
    const education = document.getElementById('education'); // não obrigatório
    const degree = document.getElementById('degree');
    const languages = document.getElementById('languages');
    const languagesLevel = document.getElementById('languagesLevel');
    const keywords = document.getElementById('keywords');

    let valid = true;

    if (!jobTitle.value.trim()) {
      setError(jobTitle, 'Título da Vaga é obrigatório.');
      valid = false;
    }

    if (!position.value.trim()) {
      setError(position, 'Cargo é obrigatório.');
      valid = false;
    }

    if (!experience.value.trim()) {
      setError(experience, 'Experiência é obrigatória.');
      valid = false;
    }

    if (!levelDegree.value.trim()) {
      setError(levelDegree, 'Nível de Graduação é obrigatório.');
      valid = false;
    }

    if (!degree.value.trim()) {
      setError(degree, 'Formação é obrigatória.');
      valid = false;
    }

    if (languages.value.trim() && !languagesLevel.value.trim()) {
      setError(languagesLevel, 'Se informar um idioma, o nível é obrigatório.');
      valid = false;
    }

    if (!keywords.value.trim()) {
      setError(keywords, 'Palavras-Chave são obrigatórias. Separe por vírgula, ponto e vírgula ou por linha.');
      valid = false;
    }

    return valid;
  }

  window.validateVagaForm = validate;

  form.addEventListener('submit', (e) => {
    if (!validate()) {
      e.preventDefault();
    }
  });
});
</script>


<script>
document.querySelector('form').addEventListener('submit', async function(e) {
    e.preventDefault();
    // Pega o id da área do usuário do localStorage
    const idAreaUsuario = localStorage.getItem('idAreaUsuario');
    function formatFormacao(value) {
        if (!value) return '';
        value = value.trim().toLowerCase();
        let result = '';
        if (value.includes('fundamental')) result = 'Ensino_Fundamental_completo';
        else if (value.includes('médio incompleto')) result = 'Ensino_Medio_incompleto';
        else if (value.includes('médio completo')) result = 'Ensino_Medio_completo';
        else if (value.includes('superior cursando')) result = 'Ensino_Superior_cursando';
        else if (value.includes('superior completo')) result = 'Ensino_Superior_completo';
        else if (value.includes('pós')) result = 'Pos_graduacao';
        else if (value.includes('mestrado')) result = 'Mestrado';
        else if (value.includes('doutorado')) result = 'Doutorado';
        else result = value;
        // Garante primeira letra maiúscula
        return result.charAt(0).toUpperCase() + result.slice(1);
    }
    const data = {
        titulo: document.getElementById('jobTitle').value,
        cargo: document.getElementById('position').value,
        experiencia: document.getElementById('experience').value,
        nivelFormacao: formatFormacao(document.getElementById('levelDegree').value),
        instituicaoEnsino: formatFormacao(document.getElementById('education').value),
        curso: document.getElementById('degree').value,
        idiomas: document.getElementById('languages').value.split(',').map(s => s.trim()),
        palavrasChave: document.getElementById('keywords').value.split(',').map(s => s.trim()),
        idArea: idAreaUsuario ? parseInt(idAreaUsuario) : null
    };
    try {
        const response = await fetch('http://localhost:8080/optimiza/vagas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        if (response.ok) {
            document.querySelector('form').reset();
            Swal.fire({
                icon: 'success',
                title: 'Vaga aberta com sucesso!',
                text: 'Você será redirecionado para Vagas Abertas.',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                window.location.href = 'vagasAbertas.html';
            });
        } else {
            const errorData = await response.json();
            Swal.fire({
                icon: 'error',
                title: 'Erro ao abrir vaga',
                text:'Erro ao abrir a vaga. Tente novamente.'
            });
        }
    } catch (error) {
        alert('Erro de conexão com o servidor.');
    }
});

document.getElementById('btn-sugestao-vaga').onclick = async function() {
    const modal = document.getElementById('modal-sugestao-vaga');
    const lista = document.getElementById('lista-sugestao-vagas');
    lista.innerHTML = '<li style="color:#888;">Carregando...</li>';
    modal.style.display = 'flex';
    try {
        const response = await fetch('http://localhost:8080/optimiza/vagas/layout-vagas');
        if (response.ok) {
            const vagas = await response.json();
            lista.innerHTML = '';
            vagas.forEach(vaga => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.justifyContent = 'space-between';
                li.style.padding = '0.7rem 0.5rem';
                li.style.borderBottom = '1px solid #e9e9f7';
                li.style.color = '#032656';
                li.style.fontSize = '1.1rem';
                li.textContent = vaga.titulo;
                const btnAplicar = document.createElement('button');
                btnAplicar.textContent = 'Aplicar';
                btnAplicar.className = 'btn-aplicar-sugestao';
                btnAplicar.style.marginLeft = '1rem';
                btnAplicar.style.background = '#6C63FF';
                btnAplicar.style.color = '#fff';
                btnAplicar.style.border = 'none';
                btnAplicar.style.borderRadius = '0.4rem';
                btnAplicar.style.padding = '0.4rem 1.2rem';
                btnAplicar.style.cursor = 'pointer';
                btnAplicar.onclick = async function() {
                    btnAplicar.disabled = true;
                    btnAplicar.textContent = 'Aplicando...';
                    try {
                        const res = await fetch(`http://localhost:8080/optimiza/vagas/layout-vagas?idLayoutVaga=${vaga.id}`);
                        if (res.ok) {
                            const dados = await res.json();
                            document.getElementById('jobTitle').value = dados.titulo || '';
                            document.getElementById('position').value = getCargoValue(dados.cargo);
                            document.getElementById('experience').value = getExperienciaValue(dados.experienciaEsperada);
                            document.getElementById('levelDegree').value = getFormacaoValue(dados.nivelFormacaoEsperada);
                            document.getElementById('degree').value = dados.cursoEsperado || '';
                            document.getElementById('languages').value = Object.keys(dados.idiomasEsperados).map(idioma => idioma).join(', ');
                            document.getElementById('keywords').value = '';
                            modal.style.display = 'none';
                        } else {
                            Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível aplicar a sugestão.' });
                        }
                    } catch (err) {
                        Swal.fire({ icon: 'error', title: 'Erro', text: 'Erro de conexão.' });
                    } finally {
                        btnAplicar.disabled = false;
                        btnAplicar.textContent = 'Aplicar';
                    }
                };
                li.appendChild(btnAplicar);
                lista.appendChild(li);
            });
            if (vagas.length === 0) {
                lista.innerHTML = '<li style="color:#888;">Nenhuma sugestão encontrada.</li>';
            }
        } else {
            lista.innerHTML = '<li style="color:#d00;">Erro ao buscar sugestões.</li>';
        }
    } catch (error) {
        lista.innerHTML = '<li style="color:#d00;">Erro de conexão.</li>';
    }
};

// Funções auxiliares para mapear valores do backend para os selects
function getCargoValue(cargo) {
    if (!cargo) return '';
    cargo = cargo.toLowerCase();
    if (cargo.includes('jovem aprendiz')) return 'jovem-aprendiz';
    if (cargo.includes('estagi')) return 'estagiario';
    if (cargo.includes('júnior')) return 'analista-jr';
    if (cargo.includes('pleno')) return 'analista-pl';
    if (cargo.includes('sênior') || cargo.includes('senior')) return 'analista-sr';
    if (cargo.includes('especialista')) return 'specialist';
    if (cargo.includes('tech lead')) return 'tech-lead';
    if (cargo.includes('gerente')) return 'manager';
    return '';
}
function getExperienciaValue(exp) {
    if (!exp) return '';
    exp = exp.toLowerCase();
    if (exp.includes('nenhuma')) return 'none';
    if (exp.match(/1.*3/)) return '1-3';
    if (exp.match(/3.*5/)) return '3-5';
    if (exp.match(/5/)) return '5plus';
    return '';
}
function getFormacaoValue(formacao) {
    if (!formacao) return '';
    formacao = formacao.toLowerCase();
    if (formacao.includes('fundamental')) return 'Ensino_Fundamental_completo';
    if (formacao.includes('médio incompleto')) return 'Ensino_Medio_incompleto';
    if (formacao.includes('médio completo')) return 'Ensino_Medio_completo';
    if (formacao.includes('superior cursando')) return 'Ensino_Superior_cursando';
    if (formacao.includes('superior completo')) return 'Ensino_Superior_completo';
    if (formacao.includes('pós')) return 'Pos_graduacao';
    if (formacao.includes('mestrado')) return 'Mestrado';
    if (formacao.includes('doutorado')) return 'Doutorado';
    return '';
}
document.getElementById('close-modal-sugestao').onclick = function() {
    document.getElementById('modal-sugestao-vaga').style.display = 'none';
};
window.onclick = function(event) {
    const modal = document.getElementById('modal-sugestao-vaga');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};
</script>

</html>